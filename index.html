<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>My Docs</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/fontawesome.min.css" rel="stylesheet">
        <link href="css/brands.min.css" rel="stylesheet">
        <link href="css/solid.min.css" rel="stylesheet">
        <link href="css/v4-font-face.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body class="homepage">
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href=".">My Docs</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#despliegue-de-una-aplicacion-php-con-nginx-y-mysql-usando-docker-y-docker-compose" class="nav-link">Despliegue de una aplicación PHP con Nginx y MySQL usando Docker y Docker-compose</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#creacion-de-un-contenedor-nginx" class="nav-link">Creación de un contenedor Nginx</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#creacion-de-un-contenedor-php" class="nav-link">Creación de un contenedor PHP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#creacion-de-un-contenedor-para-datos" class="nav-link">Creación de un contenedor para Datos</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#creacion-de-un-contenedor-mysql" class="nav-link">Creación de un contenedor MySQL</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#verificacion-de-la-conexion-a-la-bbdd" class="nav-link">Verificación de la conexión a la BBDD</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="despliegue-de-una-aplicacion-php-con-nginx-y-mysql-usando-docker-y-docker-compose">Despliegue de una aplicación PHP con Nginx y MySQL usando Docker y Docker-compose</h1>
<p>Para la realización de esta práctica, se parte de una estructura de directorios y 
archivos tal que: </p>
<p><img alt="Estructura de ficheros" src="images/estructura_inicial.png" /></p>
<h2 id="creacion-de-un-contenedor-nginx">Creación de un contenedor Nginx</h2>
<p>En primer lugar, comenzaremos modificando el archivo docker-compose.yml. 
Su contenido será:</p>
<pre><code class="language-yaml">services:
  nginx:
    image: nginx:latest
    container_name: nginx-container
    ports:
      - 80:80
</code></pre>
<p>Con este contenido estamos indicando que se debe descargar una imagen de 
la última versión de Nginx, crear un contenedor con ella y que este debe 
escuchar en el puerto 80 (que se corresponde con el 80 de nuestra máquina). </p>
<p>Para que se lleven a cabo estas acciones, ejecutamos:</p>
<pre><code class="language-console">docker compose up -d
</code></pre>
<p>Y para comprobar que el contenedor está corriendo:</p>
<pre><code class="language-console">docker ps
</code></pre>
<p>Al ejecutar estos comandos, si no ha habido ningún problema, debemos 
ver la siguiente respuesta:</p>
<p><img alt="Respuesta: Nginx docker compose up" src="images/nginx_docker_compose.png" /></p>
<p>Y si accedemos al puerto 80 de la IP de la máquina virtual desde el 
navegador de la máquina anfitriona, veremos:</p>
<p><img alt="Mensaje de Nginx" src="images/nginx_navegador.png" /></p>
<p>Lo que significa que Nginx ya está funcionando sin problemas.</p>
<h2 id="creacion-de-un-contenedor-php">Creación de un contenedor PHP</h2>
<p>En primer lugar, modificaremos el archivo 'www/html/index.php'. Su 
contenido será:</p>
<pre><code class="language-php">&lt;!DOCTYPE html&gt;
&lt;head&gt;
  &lt;title&gt;¡Hola mundo!&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;h1&gt;¡Hola mundo!&lt;/h1&gt;
  &lt;p&gt;&lt;?php echo 'Estamos corriendo PHP, version: ' . phpversion(); ?&gt;&lt;/p&gt;
&lt;/body&gt;
</code></pre>
<p>Ahora, para que Nginx pueda correr nuestra aplicación PHP, modificaremos 
el archivo 'nginx/default.conf'.</p>
<p>El contenido del archivo de configuración será:</p>
<pre><code class="language-nginx">server {

     listen 80 default_server;
     root /var/www/html;
     index index.html index.php;

     charset utf-8;

     location / {
      try_files $uri $uri/ /index.php?$query_string;
     }

     location = /favicon.ico { access_log off; log_not_found off; }
     location = /robots.txt { access_log off; log_not_found off; }

     access_log off;
     error_log /var/log/nginx/error.log error;

     sendfile off;

     client_max_body_size 100m;

     location ~ .php$ {
      fastcgi_split_path_info ^(.+.php)(/.+)$;
      fastcgi_pass php:9000;
      fastcgi_index index.php;
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_intercept_errors off;
      fastcgi_buffer_size 16k;
      fastcgi_buffers 4 16k;
    }

     location ~ /.ht {
      deny all;
     }
    }
</code></pre>
<p>Ahora modificaremos el archivo 'nginx/Dockerfile'. Su contenido será:</p>
<pre><code class="language-dockerfile">FROM nginx:latest
COPY ./default.conf /etc/nginx/conf.d/default.conf
</code></pre>
<p>Y por último, volveremos a modificar el archivo 'docker-compose.yml' 
para que se descargue una imagen de PHP y se cree un contenedor a 
partir de ella. El nuevo contenido de este archivo será:</p>
<pre><code class="language-yaml">services:
  nginx:
    build: ./nginx/
    container_name: nginx-container
    ports:
      - 80:80
    links:
      - php
    volumes:
      - ./www/html/:/var/www/html/

  php:
    image: php:7.0-fpm
    container_name: php-container
    expose:
      - 9000
    volumes:
      - ./www/html/:/var/www/html/
</code></pre>
<p>Volvemos a ejecutar los comandos:</p>
<pre><code class="language-console">docker compose up -d
docker ps
</code></pre>
<p>El resultado es:</p>
<p><img alt="PHP Docker compose" src="images/php_docker_compose.png" /></p>
<p>Si ahora volvemos a acceder a nuestra máquina virtual a través del 
puerto 80 usando el navegador, podremos observar el contenido de 
la aplicación PHP que hemos creado, servida por Nginx:</p>
<p><img alt="Aplicación PHP en navegador" src="images/app_php_navegador.png" /></p>
<p>Ya tenemos Nginx y PHP funcionando sin problemas.</p>
<h2 id="creacion-de-un-contenedor-para-datos">Creación de un contenedor para Datos</h2>
<p>En el 'docker-compose.yml' está indicado que, tanto para Nginx como para PHP, 
hay que montar el directorio 'www/html'. Una manera más adecuada de hacerlo es 
crear un contenedor independiente para datos que se enlace con los contenedores 
ya existentes de Nginx y PHP. Para ello, volveremos a modificar el archivo 
'docker-compose.yml'. Su nuevo contenido será:</p>
<pre><code class="language-yaml">services: 
  nginx:
    build: ./nginx/
    container_name: nginx-container
    ports:
      - 80:80
    links:
      - php
    volumes_from:
      - app-data

  php:
    image: php:7.0-fpm
    container_name: php-container
    expose:
      - 9000
    volumes_from:
      - app-data

  app-data:
    image: php:7.0-fpm
    container_name: app-data-container
    volumes:
      - ./www/html/:/var/www/html/
    command: &quot;true&quot;
</code></pre>
<p>Volvemos a ejecutar:</p>
<pre><code class="language-console">docker compose up -d
docker ps -a
</code></pre>
<p>El resultado debe ser:</p>
<p><img alt="Tercer compose" src="images/tercer_compose.png" /></p>
<h2 id="creacion-de-un-contenedor-mysql">Creación de un contenedor MySQL</h2>
<p>Por último, crearemos un contenedor con MySQL como BBDD para la aplicación. 
En primer lugar, nos aseguraremos de que PHP podrá comunicarse con MySQL 
editando el archivo 'php/Dockerfile' e indicaremos que se instale la 
extensión de PDO (que sirve en PHP para crear conexiones a BBDD y realizar 
consultas). El contenido del archivo será:</p>
<pre><code class="language-dockerfile">FROM php:7.0-fpm
RUN docker-php-ext-install pdo_mysql
</code></pre>
<p>Tendremos que editar el archivo 'docker-compose.yml' por última vez para 
que se generen contenedores que gestionen la BBDD MySQL así como para 
relacionarlos con los contenedores que ya hemos creado (PHP, Nginx, app-data). 
El contenido final de 'docker-compose.yml' será:</p>
<pre><code class="language-yaml">services:
  nginx:
    build: ./nginx/
    container_name: nginx-container
    ports:
      - 80:80
    links:
      - php
    volumes_from:
      - app-data
  php:
    build: ./php/
    container_name: php-container
    expose:
      - 9000
    links:
      - mysql
    volumes_from:
      - app-data

  app-data:
    image: php:7.0-fpm
    container_name: app-data-container
    volumes:
      - ./www/html/:/var/www/html/
    command: &quot;true&quot;

  mysql:
    image: mysql:5.7
    container_name: mysql-container
    volumes_from:
      - mysql-data
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: mydb
      MYSQL_USER: myuser
      MYSQL_PASSWORD: password

  mysql-data:
    image: mysql:5.7
    container_name: mysql-data-container
    volumes:
      - /var/lib/mysql
    command: &quot;true&quot;
</code></pre>
<p>También modificaremos el archivo 'www/html/index.php' para que en él se 
implementen conexión y consultas a la BBDD a través de PDO. El contenido 
será:</p>
<pre><code class="language-php">     &lt;!DOCTYPE html&gt;
     &lt;head&gt;
      &lt;title&gt;¡Hola mundo!&lt;/title&gt;
     &lt;/head&gt;

     &lt;body&gt;
      &lt;h1&gt;¡Hola mundo!&lt;/h1&gt;
      &lt;p&gt;&lt;?php echo 'Estamos corriendo PHP, version: ' . phpversion(); ?&gt;&lt;/p&gt;
      &lt;?
       $database =&quot;mydb&quot;;
       $user = &quot;myuser&quot;;
       $password = &quot;password&quot;;
       $host = &quot;mysql&quot;;

       $connection = new PDO(&quot;mysql:host={$host};dbname={$database};charset=utf8&quot;, $user, $password);
       $query = $connection-&gt;query(&quot;SELECT TABLE_NAME FROM information_schema.TABLES WHERE TABLE_TYPE='BASE TABLE'&quot;);
       $tables = $query-&gt;fetchAll(PDO::FETCH_COLUMN);

        if (empty($tables)) {
          echo &quot;&lt;p&gt;No hay tablas en la base de datos \&quot;{$database}\&quot;.&lt;/p&gt;&quot;;
        } else {
          echo &quot;&lt;p&gt;La base de datos \&quot;{$database}\&quot; tiene las siguientes tablas:&lt;/p&gt;&quot;;
          echo &quot;&lt;ul&gt;&quot;;
            foreach ($tables as $table) {
              echo &quot;&lt;li&gt;{$table}&lt;/li&gt;&quot;;
            }
          echo &quot;&lt;/ul&gt;&quot;;
        }
        ?&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>Levantamos los contenedores de la aplicación ejecutando de nuevo:</p>
<pre><code class="language-console">docker compose up -d
docker ps -a
</code></pre>
<p>Que debe devolver una respuesta como esta:</p>
<p><img alt="Cuarto compose" src="images/cuarto_compose.png" /></p>
<p>Y si volvemos a acceder desde nuestro navegador a la aplicación:</p>
<p><img alt="Primera comprobación con BBDD" src="images/primera_comp_bbdd.png" /></p>
<p>Que nos responda que "No hay tablas en la base de datos..." no es un error; 
ahora sólo estamos comprobando que los contenedores se han creado y que están 
enlazados correctamente. Para que se acceda a la BBDD y se muestren 
correctamente las tablas de la BBDD será necesario hacer una pequeña 
modificación.</p>
<h2 id="verificacion-de-la-conexion-a-la-bbdd">Verificación de la conexión a la BBDD</h2>
<p>El motivo por el que las tablas no están visibles en la aplicación es que 
la conexión que estamos realizando desde 'www/html/index.php' utiliza los 
datos de un usuario sin privilegios para acceder a las tablas de la BBDD. 
Para acceder con un usuario con permisos y que podamos comprobar que la 
conexión a la BBDD funciona y devuelve datos correctos, es necesario, en 
'www/html/index.php', cambiar los valores de dos variables:</p>
<pre><code class="language-php">$user = &quot;root&quot;;
$password = &quot;secret&quot;;
</code></pre>
<p>Con este pequeño cambio, si accedemos de nuevo a la aplicación desde el 
navegador, podremos ver los datos almacenados en la BBDD (en este caso, 
estamos consultando los nombres de las tablas existentes):</p>
<p><img alt="App funcional" src="images/finale.png" /></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js"></script>
        <script src="search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.6.1
Build Date UTC : 2025-02-19 22:37:03.956386+00:00
-->
